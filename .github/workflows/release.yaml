# .github/workflows/release.yml

name: Release

on:
  push:
    branches:
      - main
    paths:
      - 'packages/*/package.json'
      - '.changeset/**'

env:
  CI: true

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write

jobs:
  # Check if there are version changes to publish
  check-version:
    name: Check for version changes
    runs-on: ubuntu-latest
    outputs:
      has-changesets: ${{ steps.check.outputs.has-changesets }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: Check for version changes or changesets
        id: check
        run: |
          # Check if package.json versions changed in this commit
          CHANGED=$(git diff HEAD^ HEAD --name-only | grep -E "packages/.*/package.json" || echo "")

          # Check if there are changeset files
          CHANGESETS=$(ls .changeset/*.md 2>/dev/null | grep -v "README.md" | wc -l)

          if [ -n "$CHANGED" ]; then
            echo "has-changesets=true" >> $GITHUB_OUTPUT
            echo "✓ Version changes detected in:"
            echo "$CHANGED"
          elif [ "$CHANGESETS" -gt 0 ]; then
            echo "has-changesets=true" >> $GITHUB_OUTPUT
            echo "✓ Changeset files found (need to run bump locally)"
          else
            echo "has-changesets=false" >> $GITHUB_OUTPUT
            echo "No version changes detected"
          fi

  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.has-changesets == 'true'
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup (Install node & pnpm)
        uses: ./.github/actions/setup

      - name: Build packages
        run: pnpm build

      - name: Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          publish: pnpm ci:release
          title: 'chore: version packages'
          commit: 'chore: version packages'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.VINICUNCA_NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.VINICUNCA_NPM_TOKEN }}
